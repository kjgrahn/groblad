#!/usr/bin/perl -w # -*- perl -*-
#
# kärlvl - extract data from http://www.nrm.se/fbo/chk/
#          Checklista över Nordens kärlväxter
#          Thomas Karlsson,
#          Naturhistoriska riksmuseet
# 
# $Id: kärlvl,v 1.6 2004-08-09 08:09:59 grahn Exp $
# 
# Copyright (c) 2004 Jörgen Grahn <jgrahn@algonet.se>
# All rights reserved.

# All this assumes that the format doesn't change, of course.  But it
# seems to be generated by something, and so should stay constant.
#
# the weird pseudo-hidden-zeros convention seems to be
# 000000 hybrids (mostly, also eight forms)
# 0000   variants, and 29 'trade names'
# 00     subspecies, and one 'trade name'
#
# - Genera start the 2nd column with a <B>.
# - Families start the 2nd column with stupid font size tricks.
# - Names below the species level start the 2nd column with
#   even more stupid font color tricks.
# - Status letters are "abt?- ".
#
# The taxonomic order is the obvious one: 1, 1b, 2, ...
# setenv LC_COLLATE C
# ls -1 falat* | sort -k1.6 -n |xargs ./kärlvl
#
#

use strict;

my ($genus, $species);

while(<>) {
    chomp;
    next unless /<td>/;

    my @bits = split /<td.*?>/;
    next unless @bits eq 4;

    my ($dummy, $status, $latin, $se) = map {s|</td>||; $_} @bits;

    next if $latin =~ m|^<A HREF|;
    if($status eq ' ' and $latin =~ m|^<font size.+?<B>(\w+?ceae)|) {
	printf "\n%-20s [%s]\n", "", $1;
	next;
    }
    if($status eq ' ' and $latin =~ m|^<B>(.+?)</B>|) {
	$genus = $1;
	next;
    }

    my $sci;

    if($latin =~ m|^<FONT COLOR.+?FONT>(.+)|) {
	my $ssp = $1;
	$ssp =~ s|\s*[\([:upper:]].+||;
	if($ssp =~ /×/) {
	    $sci = "$genus $ssp";
	}
	else {
	    $sci = "$genus $species $ssp";
	}
    }
    else {
	$latin =~ s|\s*[\([:upper:]].+||;
	$species = $latin;
	$sci = "$genus $species";
    }

    next if $status =~ /[t?-]/;

    printf "%-20s %s\n", $se, $sci;
}
